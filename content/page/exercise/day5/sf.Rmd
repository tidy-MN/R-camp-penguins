---
title: "sf is awesome"
date: "2023-11-07"
output: 
  blogdown::html_page: 
    highlight: tango
    css: ../../css/camp_style.css
    number_sections: true
    self_contained: false
    fontsize: 18pt
    monofont: Source Code Pro
    toc: true
    toc_depth: 1
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = F)
```

## Spatial analysis with R

A major powertool in R for spatial analysis and geograpy data processing is the *sf* package.

![https://gist.github.com/edzer/f461a3a95570c4ab7edf3125c2f19d20](https://user-images.githubusercontent.com/520851/34849243-0972e474-f722-11e7-9a3d-2d4bf5075835.png)

### Reading in data

The main type of data you will be reading in are [shapefiles](https://en.wikipedia.org/wiki/Shapefile). Shapefiles are not one file, but are actually a set of files that include the data, the attributes of the coordinates, the projection, the coordinates, and information that tells the software the type of data it is.

Let's pull in some point tree data from San Francisco and play with it a bit.

```{r birds, echo = FALSE, message = FALSE, warning = FALSE}
library(sf)
library(tidyverse)
sf_trees <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2020/2020-01-28/sf_trees.csv")
```

Now, let's look at the data

```{r trees view, echo = FALSE, message = FALSE, warning = FALSE}
view(sf_trees)

```

You can see that there are latitude and longitude columns, but R does not yet know that this is a geographic dataset.

```{r trees geo, echo = FALSE, message = FALSE, warning = FALSE}

sf_trees_geo <- st_as_sf(sf_trees, coords = c("longitude", "latitude"), crs = 4326, remove = FALSE)

```

We get an error for missing coordinates, so let's get rid of the missing coordinates.

```{r trees geo na, echo = FALSE, message = FALSE, warning = FALSE}

sf_trees <- filter(sf_trees, !is.na(longitude), !is.na(latitude))

sf_trees_geo <- st_as_sf(sf_trees, coords = c("longitude", "latitude"), crs = 4269, remove = FALSE)

```

We can check that the data set is a geographic dataset by looking at a plot of the data.

```{r trees plot, echo = FALSE, message = FALSE, warning = FALSE}

plot(sf_trees_geo[1])
```

Looks like there are some trees in the wrong spot. So, let's look at which trees intersect with the City of San Francisco shapefile. We will read in the shapefile and then run an intersection.


Buffers
Geom_sf

```{r interescts}
library(tigris)

city_shape <- st_read("https://data.sfgov.org/api/geospatial/pdvd-w2q4?method=export&format=Shapefile")

cities <- metro_divisions()

san_fran <- filter(cities, grepl("San Francisco", NAME))

st_crs(san_fran)

trees_in_san_fran <- st_intersection(sf_trees_geo, san_fran)

```

Now let's draw a buffer around each tree that remains inside the boundary of San Francisco proper. To draw a buffer we need to make sure the coordinates are correct. Remember when we talked about coordinate reference systems? Universal tranverse mercator, or UTMs have coordinates in meters. San Francisco is in UTM zone 10.

```{r trees buffer}
trees_in_san_fran <- st_transform(trees_in_san_fran, crs = 32610)
trees_in_san_fran <- st_buffer(trees_in_san_fran, dist = 1000)
```

Finally, let's see which tree is the farthest distance from a loon in Leech Lake, Minnesota.

```{r trees distance}
leech_lake_center_lat <- 47.162382 
leech_lake_center_long <- -94.428769

coords <- c(leech_lake_center_long, leech_lake_center_lat)

leech_lake_mn <- st_sfc(st_point(coords))

leech_lake_mn <- st_as_sf(leech_lake_mn, crs = 9822)

trees_in_san_fran <- st_transform(trees_in_san_fran, crs = 9822)
trees_in_san_fran_center <- st_centroid(trees_in_san_fran)

distance_to_loons <- st_distance(leech_lake_mn, trees_in_san_fran_center)
```


